<?php
session_start();
include '../database/db.php';

if (!isset($_SESSION['user_type']) || $_SESSION['user_type'] !== 'admin') {
    header("Location: ../index.php");
    exit();
}

// Check if the connection was successful
if (!$conn) {
    die("Connection failed: " . mysqli_connect_error());
}

// Include TCPDF
require_once('../vendor/tecnickcom/tcpdf/tcpdf.php');

// Check if PDF generation is requested
if (isset($_GET['generate_pdf'])) {
    // Create new PDF document
    $pdf = new TCPDF();
    $pdf->SetCreator(PDF_CREATOR);
    $pdf->SetAuthor('SSLG System');
    $pdf->SetTitle('Election Results');
    $pdf->SetHeaderData('', 0, 'Election Results', 'Generated by SSLG System');
    $pdf->setHeaderFont(Array(PDF_FONT_NAME_MAIN, '', PDF_FONT_SIZE_MAIN));
    $pdf->setFooterFont(Array(PDF_FONT_NAME_DATA, '', PDF_FONT_SIZE_DATA));
    $pdf->SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);
    $pdf->SetMargins(10, 10, 10);
    $pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);
    $pdf->AddPage();

    // Fetch completed election
    $election_query = "SELECT * FROM elections WHERE status = 'completed'";
    $election_result = $conn->query($election_query);

    if ($election_result->num_rows > 0) {
        $election = $election_result->fetch_assoc();
        $pdf->SetFont('helvetica', 'B', 16);
        $pdf->Cell(0, 10, htmlspecialchars($election['title']) . ' Results', 0, 1, 'C');
        $pdf->Ln(10);

        // Get distinct positions sorted correctly
        $positions_query = "SELECT DISTINCT position FROM candidates 
                           WHERE election_id = {$election['id']} 
                           ORDER BY FIELD(position, 
                               'President', 
                               'Vice President', 
                               'Secretary', 
                               'Treasurer',
                               'Auditor',
                               'Grade 12 Representative',
                               'Grade 11 Representative',
                               'Grade 10 Representative',
                               'Grade 9 Representative',
                               'Grade 8 Representative',
                               'Grade 7 Representative'
                           ) ASC";
        $positions_result = $conn->query($positions_query);

        while ($position = $positions_result->fetch_assoc()) {
            $current_position = $position['position'];
            $pdf->SetFont('helvetica', 'B', 14);
            $pdf->Cell(0, 10, htmlspecialchars($current_position), 0, 1);
            $pdf->SetFont('helvetica', '', 12);

            // Table header
            $pdf->Cell(80, 10, 'Candidate', 1);
            $pdf->Cell(40, 10, 'Votes', 1);
            $pdf->Cell(40, 10, 'Percentage', 1);
            $pdf->Ln();

            // Get candidates and their votes for current position
            $candidates_query = "
                SELECT 
                    c.id,
                    s.FullName as candidate_name,
                    COUNT(v.id) as vote_count,
                    c.image_url,
                    c.partylist_name
                FROM candidates c
                LEFT JOIN students s ON c.student_id = s.StudentID
                LEFT JOIN votes v ON c.id = v.candidate_id
                WHERE c.election_id = {$election['id']}
                AND c.position = '$current_position'
                GROUP BY c.id
                ORDER BY vote_count DESC";

            $candidates_result = $conn->query($candidates_query);
            $total_votes_query = "
                SELECT COUNT(*) as total 
                FROM votes 
                WHERE candidate_position = '$current_position'
                AND election_id = {$election['id']}";
            $total_votes_result = $conn->query($total_votes_query);
            $total_votes = $total_votes_result->fetch_assoc()['total'];

            while ($candidate = $candidates_result->fetch_assoc()) {
                $percentage = $total_votes > 0 ? ($candidate['vote_count'] / $total_votes) * 100 : 0;
                $pdf->Cell(80, 10, htmlspecialchars($candidate['candidate_name']), 1);
                $pdf->Cell(40, 10, $candidate['vote_count'], 1);
                $pdf->Cell(40, 10, number_format($percentage, 1) . '%', 1);
                $pdf->Ln();
            }
            $pdf->Ln();
        }
    } else {
        $pdf->Cell(0, 10, 'No completed election found.', 0, 1, 'C');
    }

    // Output PDF
    $pdf->Output('election_results.pdf', 'I');
    exit();
}
?>

<!DOCTYPE html>
<html>

<head>
  <title>Election Results</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Add SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    Swal.fire({
      title: 'Election Results',
      text: 'Do you want to download the PDF?',
      icon: 'info',
      showCancelButton: true,
      confirmButtonText: 'Download PDF',
      cancelButtonText: 'Cancel'
    }).then((result) => {
      if (result.isConfirmed) {
        window.location.href = '?generate_pdf=1'; // Redirect to PDF generation
      }
    });
  });
  </script>
</head>

<body class="bg-gray-50">
  <div class="flex">
    <!-- Include Admin Sidebar -->
    <?php include '../components/admin_sidebar.php'; ?>

    <!-- Main Content -->
    <div class="flex-1 p-8">
      <h2 class="text-3xl font-bold mb-6 text-center text-gray-800">
        Election Results
      </h2>
      <div class="text-center mb-4">
        <a href="?generate_pdf=1" class="btn btn-primary">Download PDF</a>
      </div>
    </div>
  </div>
</body>

</html>